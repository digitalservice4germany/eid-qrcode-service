<div
  layout:decorate="~{layout/base}"
  layout:fragment="content"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
  <div class="container" th:classappend="${additionalClass}">
    <div class="widget">
      <div
        th:if="${isFallback}"
        th:insert="fragments/error :: notification(text=#{widget.fallback.error.text})"
      ></div>
      <div class="cards">
        <img
          class="img-responsive"
          src="images/id-1x.png"
          th:alt="#{widget.headline-image-alt}"
          srcset="images/id-2x.png 2x"
        />
        <img
          class="app-icon"
          src="images/app-icon.svg"
          th:alt="#{widget.app-icon-image-alt}"
        />
      </div>
      <div class="headline">
        <h1>
          <span th:text="#{widget.headline-title}"></span>
        </h1>
      </div>
      <div class="app-stores">
        <div class="app-stores__wrapper">
          <img
            class="icon-list"
            src="images/list-1.svg"
            th:alt="#{widget.step-one-alt}"
          />
          <div class="app-stores__content">
            <h2 th:text="#{widget.download-title}"></h2>
            <div class="app-stores__content__images">
              <a th:href="#{widget.play-store-url}" target="_blank">
                <img
                  class="play-store"
                  loading="lazy"
                  src="images/play-store.svg"
                  th:alt="#{widget.play-store-alt}"
                />
              </a>
              <a th:href="#{widget.app-store-url}" target="_blank">
                <img
                  class="app-store"
                  loading="lazy"
                  src="images/app-store.svg"
                  th:alt="#{widget.app-store-alt}"
                />
              </a>
            </div>
          </div>
        </div>
      </div>
      <div
        class="qrcode"
        style="
          background-color: #e0f1fb;
          border-radius: 10px;
          padding: 12px;
          color: #0b0c0c;
          display: flex;
          grid-column-gap: 9px;
          grid-row-gap: 9px;
          margin-top: 10px;
        "
      >
        <img
          class="icon-list"
          src="images/list-2.svg"
          th:alt="#{widget.step-two-alt}"
        />
        <div class="app-stores__content">
          <h2 style="margin-top: 0; margin-bottom: 0.5rem">QR-Code scannen</h2>
          <div id="qrcode" style="background: white; padding: 0.4rem"></div>
        </div>
      </div>
      <div class="data-privacy-wrapper">
        <a
          th:href="#{widget.data-privacy-url}"
          target="_blank"
          class="data-privacy-button"
          th:text="#{widget.data-privacy-button} + ' &#8599;'"
        >
        </a>
      </div>
    </div>
    <script src="js/qrcode.min.js"></script>
    <script type="text/javascript" src="js/eventSource.js"></script>
    <script type="text/javascript">
      let qrCode, tcToken, hash, useIdSessionId;
      const baseUrl = "desktopident://127.0.0.1:24727/eID-Client";

      function refreshTimeBasedToken() {
        fetch(`/api/v1/identification/sessions/${useIdSessionId}/tokens`, {
          method: "POST",
        })
          .then((r) => r.json())
          .then((jsonResponse) => {
            const url = `${baseUrl}?${tcToken}&${hash}&widgetSessionId=${widgetSessionId}&tokenId=${jsonResponse.tokenId}`;
            qrCode.makeCode(url);
            setTimeout(refreshTimeBasedToken, 50000);
          });
      }

      window.addEventListener("load", () => {
        hash = `hash=${new URL(window.location).searchParams.get("hash")}`;
        tcToken = window.location.hash.replace("#", "");
        useIdSessionId = decodeURIComponent(tcToken).match(
          /sessions\/([a-f\d\-]*)\/tc-token/i
        )[1];
        console.log("useIdSessionId: " + useIdSessionId);
        qrCode = new QRCode(document.getElementById("qrcode"), {
          colorDark: "#004b76",
          correctLevel: QRCode.CorrectLevel.L,
        });
        refreshTimeBasedToken();
      });
    </script>
    <script type="text/javascript">
      function createCredentials() {
        let credentialId;

        fetch(`/api/v1/credentials`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            widgetSessionId: widgetSessionId,
            refreshAddress: "https://digitalservice.bund.de",
          }),
        })
          .then((r) => r.json())
          .then((startRegistrationResponse) => {
            credentialId = startRegistrationResponse.credentialId;
            return createWebAuthnCredentialsViaBrowser(
              startRegistrationResponse
            );
          })
          .then((credentials) => {
            updateCredentials(credentialId, convertCredentials(credentials));
          });
      }

      function createWebAuthnCredentialsViaBrowser(startRegistrationResponse) {
        let pkcCreationOptions = JSON.parse(
          startRegistrationResponse.pkcCreationOptions
        );

        pkcCreationOptions.publicKey.challenge = base64urlToUint8Array(
          pkcCreationOptions.publicKey.challenge
        );
        pkcCreationOptions.publicKey.user.id = base64urlToUint8Array(
          pkcCreationOptions.publicKey.user.id
        );

        return navigator.credentials.create(pkcCreationOptions);
      }

      function convertCredentials(credentials) {
        let flatCred = flatten(credentials);
        flatCred.response = flatten(flatCred.response);
        flatCred.response.transports = credentials.response.getTransports();
        flatCred.clientExtensionResults =
          credentials.getClientExtensionResults();
        flatCred.rawId = decodeArrayBuffer(credentials.rawId);
        flatCred.response.clientDataJSON = decodeArrayBuffer(
          credentials.response.clientDataJSON
        );
        flatCred.response.attestationObject = decodeArrayBuffer(
          credentials.response.attestationObject
        );
        return flatCred;
      }

      function updateCredentials(credentialId, flatCred) {
        fetch(`/api/v1/credentials/${credentialId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(flatCred),
        });
      }

      function flatten(obj) {
        let result = {};
        for (let key in obj) {
          result[key] = obj[key];
        }
        return result;
      }

      function decodeArrayBuffer(buffer) {
        let uint8Array = new Uint8Array(buffer);
        let string = String.fromCharCode.apply(null, uint8Array);
        let b64 = btoa(string);
        let b64url = b64
          .replace(/=/g, "")
          .replace(/\+/g, "-")
          .replace(/\//g, "_");
        return b64url;
      }

      function base64urlToUint8Array(base64url) {
        let base64 = base64url
          .replace(/-/g, "+")
          .replace(/_/g, "/")
          .replace(/\s/g, "");
        let string = atob(base64);
        let charCodeArray = string.split("").map((c) => c.charCodeAt(0));
        return new Uint8Array(charCodeArray);
      }

      createCredentials();
    </script>
  </div>
</div>
